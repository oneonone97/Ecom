/**
 * Test Admin Product Creation to Supabase
 * 
 * This script simulates an admin creating a product and verifies
 * it appears in Supabase database.
 */

require('dotenv').config({ path: require('path').join(__dirname, '../.env') });
const sequelize = require('../config/database');
const Product = require('../models/Product');
const Category = require('../models/Category');

async function testAdminProductCreation() {
  console.log('ğŸ§ª Testing Admin Product Creation to Supabase\n');
  console.log('='.repeat(60));

  try {
    // Step 0: Check environment configuration
    console.log('\nâš™ï¸  Step 0: Checking environment configuration...');
    if (!process.env.DATABASE_URL) {
      console.error('âŒ DATABASE_URL not found in environment variables!');
      console.error('\nğŸ“ Please set DATABASE_URL in your .env file:');
      console.error('   DATABASE_URL=postgresql://postgres:[PASSWORD]@db.jvtbbtymefaolozvdpet.supabase.co:5432/postgres');
      console.error('\nğŸ’¡ Make sure your .env file exists in MyShop-backend directory');
      process.exit(1);
    }
    
    const isSupabase = process.env.DATABASE_URL.includes('supabase.co');
    const dbType = isSupabase ? 'Supabase PostgreSQL' : 
                   process.env.DATABASE_URL.startsWith('sqlite:') ? 'SQLite (Local)' : 
                   'PostgreSQL (Other)';
    console.log('âœ… DATABASE_URL found');
    console.log('   Database Type:', dbType);
    if (isSupabase) {
      console.log('   Supabase URL:', process.env.DATABASE_URL.split('@')[1]?.split('/')[0] || 'N/A');
    }

    // Step 1: Verify database connection
    console.log('\nğŸ“¡ Step 1: Verifying database connection...');
    await sequelize.authenticate();
    console.log('âœ… Connected to database:', dbType);
    
    // Step 2: Get or create a test category
    console.log('\nğŸ“¦ Step 2: Preparing test category...');
    let testCategory = await Category.findOne({ where: { name: 'Electronics' } });
    if (!testCategory) {
      // Try to find any existing category first
      testCategory = await Category.findOne({ where: { isActive: true } });
      if (!testCategory) {
        // Create category with all required fields (slug will be auto-generated by hook)
        testCategory = await Category.create({ 
          name: 'Electronics',
          slug: 'electronics', // Explicitly set slug to avoid validation error
          description: 'Test category for product creation',
          isActive: true
        });
        console.log('âœ… Created test category:', testCategory.name);
      } else {
        console.log('âœ… Using existing category:', testCategory.name);
      }
    } else {
      console.log('âœ… Using existing category:', testCategory.name);
    }

    // Step 3: Create a test product (simulating admin creation)
    console.log('\nğŸ›ï¸  Step 3: Creating test product (simulating admin action)...');
    const testProductData = {
      name: `Test Product ${Date.now()}`,
      description: 'This is a test product created to verify Supabase integration',
      price_paise: 99900, // â‚¹999.00
      sale_price_paise: 79900, // â‚¹799.00
      categoryId: testCategory.id,
      stock: 50,
      featured: true,
      is_new: true,
      is_sale: true,
      image_url: 'https://via.placeholder.com/300'
    };

    const createdProduct = await Product.create(testProductData);
    console.log('âœ… Product created successfully!');
    console.log('   Product ID:', createdProduct.id);
    console.log('   Product Name:', createdProduct.name);
    console.log('   Price: â‚¹' + (createdProduct.price_paise / 100).toFixed(2));
    console.log('   Category ID:', createdProduct.categoryId);

    // Step 4: Verify product exists in database
    console.log('\nğŸ” Step 4: Verifying product in database...');
    const foundProduct = await Product.findByPk(createdProduct.id, {
      include: [{ model: Category, as: 'category' }]
    });

    if (foundProduct) {
      console.log('âœ… Product found in database!');
      console.log('   ID:', foundProduct.id);
      console.log('   Name:', foundProduct.name);
      console.log('   Description:', foundProduct.description);
      console.log('   Price: â‚¹' + (foundProduct.price_paise / 100).toFixed(2));
      console.log('   Sale Price: â‚¹' + (foundProduct.sale_price_paise / 100).toFixed(2));
      console.log('   Stock:', foundProduct.stock);
      console.log('   Category:', foundProduct.category?.name || 'N/A');
      console.log('   Featured:', foundProduct.featured);
      console.log('   Created At:', foundProduct.createdAt);
    } else {
      throw new Error('Product not found after creation!');
    }

    // Step 5: Query directly from Supabase to confirm
    console.log('\nğŸ—„ï¸  Step 5: Querying database directly...');
    const products = await sequelize.query(
      'SELECT id, name, price_paise, stock, "categoryId", "createdAt" FROM "Products" WHERE id = :productId',
      {
        replacements: { productId: createdProduct.id },
        type: sequelize.QueryTypes.SELECT
      }
    );

    if (products && products.length > 0) {
      console.log('âœ… Product confirmed in Supabase database!');
      console.log('   Raw database record:', JSON.stringify(products[0], null, 2));
    } else {
      throw new Error('Product not found in direct database query!');
    }

    // Step 6: Count total products
    console.log('\nğŸ“Š Step 6: Database statistics...');
    const totalProducts = await Product.count();
    const totalCategories = await Category.count();
    console.log('   Total Products in Database:', totalProducts);
    console.log('   Total Categories in Database:', totalCategories);

    // Step 7: Summary
    console.log('\n' + '='.repeat(60));
    console.log('âœ… TEST PASSED: Admin product creation works with Supabase!');
    console.log('\nğŸ“ Summary:');
    console.log('   âœ… Database connection: Working');
    console.log('   âœ… Product creation: Working');
    console.log('   âœ… Data persistence: Working');
    console.log('   âœ… Supabase integration: Working');
    console.log('\nğŸ’¡ Next Steps:');
    console.log('   1. Go to Supabase Dashboard â†’ Table Editor');
    console.log('   2. Select "Products" table');
    console.log('   3. You should see the test product there!');
    console.log('   4. Product ID to look for:', createdProduct.id);
    console.log('\nğŸ§¹ Cleanup (optional):');
    console.log(`   To delete test product: DELETE FROM "Products" WHERE id = ${createdProduct.id};`);

  } catch (error) {
    console.error('\nâŒ TEST FAILED:', error.message);
    console.error('   Error details:', error);
    process.exit(1);
  } finally {
    await sequelize.close();
  }
}

// Run the test
testAdminProductCreation()
  .then(() => {
    console.log('\nâœ… Test completed successfully!');
    process.exit(0);
  })
  .catch((error) => {
    console.error('\nâŒ Test failed:', error);
    process.exit(1);
  });

